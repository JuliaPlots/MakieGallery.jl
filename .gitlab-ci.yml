variables:
  CI_IMAGE_TAG: "opengl"
  MODERNGL_DEBUGGING: "true"
  JULIA_DEPOT_PATH: "$CI_PROJECT_DIR/.julia/"
  CI_DEV_PKGS: "Makie#master AbstractPlotting#master GLMakie#master StatsMakie#master MakieLayout#master GeoMakie#master"
  CI_WEEKSTAMP: $(date +%Y/%m:W%U)

stages:
  - test
  - refimages

gallerytest:

  stage: test

  tags:
      - xorg

  image: "juliagpu/julia:v1.3-${CI_IMAGE_TAG}"

  cache:
    key: ${CI_WEEKSTAMP} # clear this every week or so
    paths:
      - .julia/artifacts
      - .julia/packages

  before_script:
      - echo The cache ID is $CI_WEEKSTAMP
      - apt-get -qq update
      # glfw
      - apt-get install -y cmake xorg-dev mesa-utils p7zip-full

  script:
    - mkdir $JULIA_DEPOT_PATH # Pkg.jl#325
    - glxinfo | grep 'version'
    - julia -e 'using InteractiveUtils; versioninfo()'
    - julia --project -e "using Pkg;
                          pkg\"add $CI_DEV_PKGS; gc\""
    - julia --project -e 'using Pkg; pkg"test"'

  artifacts:
    when: always
    paths:
      - test/tested_different
      - test/test_recordings
      - Project.toml
      - Manifest.toml
    expire_in: 4 days

deploy:

  stage: refimages

  when: manual

  dependencies:
    - gallerytest

  tags:
    - xorg

  image: "juliagpu/julia:v1.3-${CI_IMAGE_TAG}"

  cache:
    key: ${CI_WEEKSTAMP} # clear this every week or so
    paths:
      - .julia/artifacts
      - .julia/packages

  before_script:
      - apt-get -qq update
      - apt-get install -y cmake xorg-dev mesa-utils p7zip-full

  script:
    - julia --project test/upgrade_recordings.jl

# before_script:
#   - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
#   - eval $(ssh-agent -s)
#   - ssh-add <(echo "$GIT_SSH_PRIV_KEY")
#   - git config --global user.email "kll@dev.terastrm.net"
#   - git config --global user.name "Mr. Robot"
#   - mkdir -p ~/.ssh
#   - cat gitlab-known-hosts >> ~/.ssh/known_hosts
# script:
#   - git clone git@gitlab.dev.terastrm.net:${CI_PROJECT_PATH}.git
#   - cd ${CI_PROJECT_NAME}
#   - git checkout ts
#   - git rebase master
#   - git push --force origin ts
